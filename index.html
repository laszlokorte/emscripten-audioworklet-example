<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <link rel="icon" href="favicon.svg" />
        <title>WASM AudioWorklet Test</title>
    </head>
    <body>
        <div class="app">
            <header>
                <h1>WASM + Audioworklet</h1>
                <p>Simple WASM+AudioWorklet example.</p>
                <p>Click the buttons below to play sounds.</p>
                <fieldset>
                    <button id="lkStart">Start</button>
                    <button id="lkStop">Stop</button>
                    <button id="lkPeep">Peep</button>
                    <div class="controls">
                        <label>
                            Base Frequency:
                            <input
                                type="range"
                                min="0"
                                max="1000"
                                id="lkFreq"
                                value="220"
                            />
                        </label>
                        <label>
                            Volume:
                            <input
                                type="range"
                                min="0"
                                max="1"
                                step="0.01"
                                id="lkAmpl"
                                value="0.1"
                            />
                        </label>
                    </div>
                </fieldset>
            </header>
            <div class="grid" id="lkGrid">
                <section>
                    <h2>Canvas</h2>
                    <canvas id="lkCanvas" width="800" height="600"></canvas>
                </section>
                <section>
                    <h2>Log</h2>
                    <pre id="lkLog"></pre>
                </section>
            </div>

            <script type="module">
                function log(msg) {
                    if (lkLog.childNodes.length > 10) {
                        lkLog.removeChild(lkLog.firstChild);
                    }
                    lkLog.appendChild(document.createTextNode(msg + "\n"));
                }
                const memory = new WebAssembly.Memory({
                    initial: 2,
                    maximum: 2,
                    shared: true,
                });

                const wasm = await WebAssembly.compileStreaming(
                    fetch("build/main.wasm"),
                );
                const instance = await WebAssembly.instantiate(wasm, {
                    env: {
                        memory,
                    },
                });

                const blockSize = 128;

                const audioCtx = new AudioContext({ samplingRate: 44100 });
                await audioCtx.audioWorklet.addModule("worklet.js");

                const bufferNode = new AudioWorkletNode(
                    audioCtx,
                    "wasm-processor",
                    {
                        processorOptions: { memory, wasm },
                    },
                );
                const volume = audioCtx.createGain();
                const gain = audioCtx.createGain();
                gain.gain.value = 0; // start bei 0
                instance.exports.setup();

                volume.gain.value = lkAmpl.valueAsNumber;
                bufferNode.connect(volume);
                volume.connect(gain);
                gain.connect(audioCtx.destination);
                const freqParam = bufferNode.parameters.get("freq");
                freqParam.value = lkFreq.value;
                lkPeep.addEventListener("click", async () => {
                    if (
                        instance.exports.play_sound(
                            440 *
                                Math.pow(
                                    2,
                                    Math.round(Math.random() * 12) / 12,
                                ),
                            0.4,
                        )
                    ) {
                        const free = instance.exports.count_free_sounds();
                        const active = instance.exports.count_playing_sounds();
                        log(`Playing Sound ${active}/${active + free}`);
                    } else {
                        log("Limits of concurent sounds reached");
                    }
                });
                lkStart.addEventListener("click", async () => {
                    const now = audioCtx.currentTime;
                    const fadeTime = 0.1;
                    lkGrid.classList.remove("loading");
                    await audioCtx.resume();
                    gain.gain.cancelScheduledValues(now);
                    gain.gain.setValueAtTime(gain.gain.value, now);
                    gain.gain.linearRampToValueAtTime(
                        1,
                        audioCtx.currentTime + fadeTime,
                    );
                    requestAnimationFrame(draw);

                    log("Enable Sound");
                });
                lkStop.addEventListener("click", async () => {
                    const now = audioCtx.currentTime;
                    const fadeTime = 0.1;
                    await audioCtx.resume();
                    gain.gain.cancelScheduledValues(now);
                    gain.gain.linearRampToValueAtTime(
                        gain.gain.value,
                        audioCtx.currentTime,
                    );
                    gain.gain.linearRampToValueAtTime(
                        0.0,
                        audioCtx.currentTime + fadeTime,
                    );
                    log("Disable Sound");
                });

                lkFreq.addEventListener("input", async (evt) => {
                    freqParam.setValueAtTime(
                        evt.currentTarget.valueAsNumber,
                        audioCtx.currentTime,
                    );
                });

                lkAmpl.addEventListener("input", async (evt) => {
                    volume.gain.cancelScheduledValues(audioCtx.currentTime);
                    volume.gain.linearRampToValueAtTime(
                        volume.gain.value,
                        audioCtx.currentTime,
                    );
                    volume.gain.linearRampToValueAtTime(
                        evt.currentTarget.value,
                        audioCtx.currentTime + 0.1,
                    );
                });
                window.addEventListener("pointermove", (evt) => {
                    if (evt.shiftKey) {
                        const dx = evt.clientX - window.innerWidth / 2;
                        const dy = evt.clientY - window.innerHeight / 2;
                        lkFreq.value = Math.round(Math.hypot(dx, dy) + 1);

                        freqParam.setValueAtTime(
                            lkFreq.value,
                            audioCtx.currentTime,
                        );
                    }
                });

                const drawCtx = lkCanvas.getContext("2d");
                drawCtx.fillStyle = "#fed";
                drawCtx.fillRect(0, 0, lkCanvas.width, lkCanvas.height);
                function draw() {
                    drawCtx.fillStyle = "#fed";
                    const sample_base =
                        instance.exports.get_sound_buffer_base();
                    const sample_count =
                        instance.exports.get_sound_buffer_size();
                    const samples = new Float32Array(
                        memory.buffer,
                        sample_base,
                        sample_count,
                    );
                    const s = samples;
                    drawCtx.fillStyle = "#fed";
                    drawCtx.fillRect(
                        0,
                        0,
                        (blockSize * lkCanvas.width) / blockSize,
                        lkCanvas.height,
                    );

                    drawCtx.fillStyle = "deepskyblue";

                    const skip = 20;
                    for (let i = 0; i < sample_count; i++) {
                        if (i % skip != 0) {
                            continue;
                        }
                        drawCtx.fillRect(
                            (i * lkCanvas.width) / sample_count,
                            lkCanvas.height / 2,
                            (skip * lkCanvas.width) / 2 / sample_count,
                            ((s[i] * lkCanvas.height) / 2) *
                                volume.gain.value *
                                gain.gain.value,
                        );
                    }
                    requestAnimationFrame(draw);
                }
            </script>
            <style>
                body {
                    font-family: monospace;
                    margin: 0;
                }
                h1 {
                    grid-column: 1 / -1;
                    grid-row: 1 / span 1;
                    margin: 0;
                }
                h2 {
                    margin: 0;
                }
                .app {
                    padding: 2em;
                    display: flex;
                    flex-direction: column;
                    gap: 1em;
                }
                .grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(18em, 1fr));
                    grid-template-rows: auto 1fr;
                    gap: 1em;
                    justify-content: stretch;
                    align-items: stretch;
                }
                .loading {
                    opacity: 0.1;
                }
                section {
                    display: flex;
                    flex-direction: column;
                    justify-content: stretch;
                    flex-grow: 1;
                }
                pre {
                    background-color: #111;
                    color: #fff;
                    padding: 1em;
                    margin: 0;
                    flex-grow: 1;
                }
                canvas {
                    background-color: lemonchiffon;
                }
                summary {
                    padding: 1em;
                    cursor: pointer;
                    background-color: #eee;
                    user-select: none;
                }
                .scroller {
                    max-height: 30vh;
                    overflow: auto;
                }
                label {
                    display: flex;
                    align-items: center;
                    gap: 1ex;
                    justify-content: end;
                    justify-self: end;
                }
                button {
                    background-color: #111;
                    color: #fff;
                    border: none;
                    border-radius: 4px;
                    padding: 1ex;
                    font: inherit;
                    cursor: pointer;
                }
                button:hover {
                    background-color: #333;
                }

                button:active {
                    background-color: #000;
                    color: #eee;
                }
                input[type="range"] {
                    padding: 1ex;
                }
                fieldset {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 1ex;
                    padding: 0;
                    border: none;
                }
                .controls {
                    display: flex;
                    flex-wrap: wrap;
                    justify-content: end;
                }
            </style>
            <details>
                <summary>Sourcecode</summary>
                <pre id="lkSource" class="scroller"><script>
                            window.addEventListener('DOMContentLoaded', () => {
                              const log = lkLog.innerText
                              lkLog.innerText = ''
                              lkSource.removeChild(lkSource.firstElementChild)
                              lkSource.appendChild(document.createTextNode(document.documentElement.outerHTML));

                              lkLog.innerText = log
                            })
                            </script></pre>
            </details>
        </div>
    </body>
</html>
